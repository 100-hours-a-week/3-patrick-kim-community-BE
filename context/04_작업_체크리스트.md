# PetStar 작업 체크리스트

> 이 문서는 Kakao Community → PetStar 리브랜딩 및 성능 최적화 작업의 진행 상황을 추적합니다.
>
> **중요**: 최적화 전 코드를 먼저 완성하고 Before 수치를 측정한 후, 단계별로 최적화를 적용합니다.

---

## 작업 워크플로우

### GitHub 이슈
- **Repository**: https://github.com/100-hours-a-week/3-patrick-kim-community-BE/issues
- 각 Phase 시작 전 이슈 생성 (gh cli 사용)

### 작업 순서 (매 Phase마다)

```
1. GitHub 이슈 확인
   └─ 해당 Phase 이슈가 있는지 확인
   └─ 없으면 gh issue create로 생성

2. 작업 진행
   └─ 이슈 번호 참조하여 커밋 (#이슈번호)

3. 작업 완료 시 (반드시 아래 순서로)
   └─ Claude 내부 TODO 업데이트 (TaskUpdate)
   └─ 체크리스트 문서 업데이트 (이 파일)
   └─ GitHub 이슈 close
```

### 세션 시작 시 (Claude에게)

```
1. 이 문서(04_작업_체크리스트.md) 읽기
2. 현재 진행 상황 파악
3. TaskCreate로 남은 작업 등록
4. GitHub 이슈 상태 확인 (gh issue list)
```

---

## GitHub 이슈 현황

| Phase | 이슈 번호 | 상태 |
|:------|:---------|:-----|
| Phase 0 | #14 | 완료 |
| Phase 1 | #16 | 완료 |
| Phase 2 | - | - |
| Phase 3 | - | - |
| Phase 4 | - | - |
| Phase 5 | - | - |
| Phase 6 | - | - |
| Phase 7 | - | - |
| Phase 8 | - | - |
| Phase 9 | - | - |

---

## Phase 0: PetStar 리브랜딩 (최적화 전 버전) ✅

> **목표**: 기본 기능만 구현. 의도적으로 최적화하지 않음.
>
> - N+1 문제 해결 X
> - 인덱스 최적화 X
> - 동시성 제어 X
> - Redis 캐싱 X

### 0-1. Enum 생성
- [x] `Species` (DOG, CAT, BIRD, FISH, RABBIT, HAMSTER, ETC)
- [x] `Gender` (MALE, FEMALE, UNKNOWN)
- [x] `ChallengeStatus` (UPCOMING, ACTIVE, ENDED)
- [x] `Role` (USER, ADMIN)

### 0-2. 신규 엔티티 생성
- [x] `Pet` 엔티티
- [x] `Challenge` 엔티티

### 0-3. 기존 엔티티 변경
- [x] `Entry` 엔티티 추가 (Post와 별도로 생성)
- [x] `Vote` 엔티티 추가 (PostLike와 별도로 생성)
- [x] `SupportMessage` 엔티티 추가 (Comment와 별도로 생성)
- [x] `Member`에 role, deletedAt 필드 추가

### 0-4. Repository 수정/생성
- [x] `PetRepository` 생성
- [x] `ChallengeRepository` 생성
- [x] `EntryRepository` 생성
- [x] `VoteRepository` 생성
- [x] `SupportMessageRepository` 생성

### 0-5. Service 수정/생성
- [x] `PetService` 생성
- [x] `ChallengeService` 생성
- [x] `EntryService` 생성
- [x] `VoteService` 생성
- [x] `SupportMessageService` 생성

### 0-6. Controller & API 경로 변경
- [x] `PetController` (`/api/v1/pets`)
- [x] `ChallengeController` (`/api/v1/challenges`)
- [x] `EntryController` (`/api/v1/entries`)
- [x] `SupportMessageController` (`/api/v1/supports`)

### 0-7. DTO 수정/생성
- [x] Pet Request/Response DTO
- [x] Challenge Response DTO
- [x] Entry Request/Response DTO
- [x] Vote Response DTO
- [x] SupportMessage Request/Response DTO

### 0-8. Mapper 생성
- [x] `PetMapper`
- [x] `ChallengeMapper`
- [x] `EntryMapper`
- [x] `SupportMessageMapper`

### 0-9. DB 마이그레이션
- [x] `pet` 테이블 생성 (JPA 자동 생성)
- [x] `challenge` 테이블 생성 (JPA 자동 생성)
- [x] `entry` 테이블 생성 (JPA 자동 생성)
- [x] `vote` 테이블 생성 (JPA 자동 생성)
- [x] `support_message` 테이블 생성 (JPA 자동 생성)

---

## Phase 1: 인프라 구축 (Terraform, Docker, ECR) ✅

> **목표**: AWS 인프라를 Terraform으로 구축하고 Docker/ECR로 애플리케이션 배포

### 1-1. Terraform 프로젝트 초기화
- [x] `terraform/` 디렉토리 생성
- [x] `provider.tf` - AWS provider 설정
- [x] `variables.tf` - 변수 정의
- [x] `terraform.tfvars` - 변수 값 (gitignore)

### 1-2. 네트워크 인프라
- [x] VPC 생성
- [x] Public/Private Subnet
- [x] Internet Gateway
- [x] Security Groups
  - [x] App 서버용 (8080, 22)
  - [x] 모니터링용 (3000, 9090)
  - [x] RDS용 (3306)

### 1-3. EC2 인스턴스
- [x] App 서버 (t3.small) - 43.200.83.214
- [x] 모니터링/k6 서버 (t3.small) - 43.201.243.102
- [x] SSH 키 페어 설정 (patrick-keypair)

### 1-4. RDS MySQL
- [x] RDS 인스턴스 생성 (db.t3.micro)
- [x] Parameter Group 설정
- [x] Subnet Group 설정
- [x] Endpoint: petstar-db.cpwka4iukgmy.ap-northeast-2.rds.amazonaws.com:3306

### 1-5. ECR & Docker
- [x] ECR 레포지토리 생성 (246077711286.dkr.ecr.ap-northeast-2.amazonaws.com/petstar)
- [x] Dockerfile 작성
- [x] Docker 이미지 빌드 (linux/amd64)
- [x] ECR 푸시 완료

### 1-6. 배포
- [x] EC2에 Docker 설치 (user_data)
- [x] docker-compose.yml 작성
- [x] 애플리케이션 배포 & 실행
- [x] API 테스트 성공 (/api/v1/challenges)

---

## Phase 2: 모니터링 구축 (Prometheus, Grafana, p6spy)

> **목표**: 애플리케이션 메트릭 수집 및 시각화

### 2-1. 애플리케이션 메트릭 설정
- [ ] Spring Actuator 의존성 추가
- [ ] Micrometer Prometheus 의존성 추가
- [ ] `/actuator/prometheus` 엔드포인트 활성화
- [ ] 커스텀 메트릭 추가 (선택)

### 2-2. 쿼리 로깅 (p6spy)
- [ ] p6spy 의존성 추가
- [ ] spy.properties 설정
- [ ] 쿼리 실행 시간 로깅
- [ ] 느린 쿼리 알림 설정 (선택)

### 2-3. Prometheus 설치
- [ ] Docker Compose에 Prometheus 추가
- [ ] prometheus.yml 설정
- [ ] 스크랩 타겟 설정 (Spring Boot)

### 2-4. Grafana 대시보드
- [ ] Docker Compose에 Grafana 추가
- [ ] Prometheus 데이터소스 연결
- [ ] JVM 메트릭 대시보드
- [ ] HTTP 요청 대시보드
- [ ] DB 커넥션 풀 대시보드

### 2-5. 알림 설정 (선택)
- [ ] Grafana 알림 규칙
- [ ] 슬랙 또는 이메일 연동

---

## Phase 3: 부하테스트 환경 구축 & Before 측정

> **목표**: 최적화 전 베이스라인 수치 측정

### 3-1. k6 환경 구축
- [ ] k6 설치 (모니터링 서버에)
- [ ] 테스트 시나리오 스크립트 작성
  - [ ] 챌린지 목록 조회
  - [ ] 참여작 목록 조회
  - [ ] 랭킹 조회
  - [ ] 투표 API
- [ ] k6 → Prometheus/Grafana 연동 (선택)

### 3-2. 테스트 데이터 시딩
- [ ] 시딩 스크립트 작성 (SQL 또는 Java)
- [ ] Member 10,000건
- [ ] Pet 15,000건
- [ ] Challenge 50건
- [ ] Entry 100,000건
- [ ] Vote 1,000,000건

### 3-3. Before 수치 측정
- [ ] 동시 50명 테스트
- [ ] 동시 100명 테스트
- [ ] 동시 200명 테스트

### 3-4. Before 수치 기록

| API | 응답시간 (avg) | p95 | RPS | 쿼리 수 | 비고 |
|:----|:--------------|:----|:----|:-------|:-----|
| GET /challenges | ms | ms | | 개 | |
| GET /challenges/{id}/entries | ms | ms | | 개 | |
| GET /challenges/{id}/ranking | ms | ms | | 개 | |
| POST /entries/{id}/votes | ms | ms | | 개 | |

---

## Phase 4: DB 인덱스 최적화

> **목표**: Full Table Scan 제거

### 4-1. 쿼리 분석
- [ ] EXPLAIN으로 실행 계획 분석
- [ ] 병목 쿼리 식별

### 4-2. 인덱스 추가
- [ ] `idx_entry_challenge_id (challenge_id, id DESC)`
- [ ] `idx_entry_challenge_vote (challenge_id, vote_count DESC)`
- [ ] `idx_entry_pet_id (pet_id)`
- [ ] `idx_entry_member_id (member_id)`
- [ ] `uk_vote_entry_member (entry_id, member_id) UNIQUE`
- [ ] `idx_support_entry_id (entry_id, id DESC)`

### 4-3. After 수치 기록

| API | Before | After | 개선율 |
|:----|:-------|:------|:------|
| 랭킹 조회 | ms | ms | % |

---

## Phase 5: JPA 쿼리 최적화 (N+1 해결)

> **목표**: API당 쿼리 수 3개 이하

### 5-1. N+1 문제 해결
- [ ] `@BatchSize` 글로벌 설정
- [ ] 참여작 목록: Fetch Join 적용
- [ ] 랭킹 조회: DTO Projection 적용
- [ ] 응원 메시지 목록: Fetch Join 적용

### 5-2. After 수치 기록

| API | Before 쿼리 수 | After 쿼리 수 | 개선율 |
|:----|:--------------|:-------------|:------|
| 참여작 목록 | 개 | 개 | % |

---

## Phase 6: 트랜잭션 & 동시성 제어

> **목표**: 데이터 정합성 100% 보장

### 6-1. 중복 투표 방지
- [ ] DB Unique 제약조건 확인
- [ ] `DataIntegrityViolationException` → 409 응답 처리

### 6-2. vote_count 정확성
- [ ] 원자적 UPDATE 쿼리 작성
- [ ] `@Modifying` 쿼리 적용

### 6-3. 동시성 테스트
- [ ] 100 스레드 동시 투표 테스트
- [ ] 데이터 정합성 검증

---

## Phase 7: 서버 코드 최적화

> **목표**: 응답 시간 추가 단축

### 7-1. 비동기 처리
- [ ] `@Async` 설정
- [ ] 알림 등 백그라운드 작업 분리

### 7-2. 커넥션 풀 최적화
- [ ] HikariCP 설정 조정
  - [ ] `maximum-pool-size: 20`
  - [ ] `minimum-idle: 5`
  - [ ] `connection-timeout: 30000`

### 7-3. 코드 최적화
- [ ] `getReferenceById()` 프록시 사용
- [ ] 불필요한 조회 제거

---

## Phase 8: Redis 캐싱 도입

> **목표**: 실시간 랭킹 10ms 이내

### 8-1. Redis 설정
- [ ] 의존성 추가
- [ ] Redis 설정 (application.yml)
- [ ] Docker Compose에 Redis 추가

### 8-2. 실시간 랭킹 (Sorted Set)
- [ ] `ranking:challenge:{challengeId}` 키 설계
- [ ] 투표 시 ZINCRBY
- [ ] 랭킹 조회 시 ZREVRANGE

### 8-3. 캐싱 적용
- [ ] 챌린지 목록: `@Cacheable` (TTL 5분)
- [ ] 참여작 상세: `@Cacheable` (TTL 10분)
- [ ] 캐시 무효화: `@CacheEvict`

---

## Phase 9: 최종 성능 검증 & After 측정

> **목표**: Before/After 비교 및 문서화

### 9-1. 최종 부하 테스트
- [ ] 동시 500명 테스트
- [ ] 동시 1,000명 테스트
- [ ] 10분 지속 테스트

### 9-2. 최종 수치 기록

| 지표 | Before | After | 개선율 |
|:----|:-------|:------|:------|
| 평균 응답 시간 | ms | ms | % |
| p95 응답 시간 | ms | ms | % |
| RPS | | | x |
| 에러율 | % | % | |
| 랭킹 조회 | ms | ms | % |
| 쿼리 수 (랭킹) | 개 | 개 | % |

### 9-3. 이력서용 성과 요약
- [ ] 한 줄 요약 작성
- [ ] 기술별 성과 정리
- [ ] Grafana 대시보드 스크린샷

---

## 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                         AWS VPC                             │
│                                                             │
│  ┌─────────────────────┐     ┌─────────────────────┐       │
│  │   EC2 (App Server)  │     │ EC2 (Monitoring/k6) │       │
│  │  ┌───────────────┐  │     │  ┌───────────────┐  │       │
│  │  │   PetStar     │  │     │  │  Prometheus   │  │       │
│  │  │  (Docker)     │──┼─────┼─▶│   (Docker)    │  │       │
│  │  └───────────────┘  │     │  └───────────────┘  │       │
│  │                     │     │  ┌───────────────┐  │       │
│  │                     │     │  │   Grafana     │  │       │
│  │                     │     │  │   (Docker)    │  │       │
│  └──────────┬──────────┘     │  └───────────────┘  │       │
│             │                │  ┌───────────────┐  │       │
│             │                │  │      k6       │  │       │
│             │                │  └───────────────┘  │       │
│             │                └─────────────────────┘       │
│             │                                               │
│             ▼                                               │
│  ┌─────────────────────┐                                   │
│  │    RDS MySQL        │                                   │
│  │   (db.t3.micro)     │                                   │
│  └─────────────────────┘                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────┐
│      ECR        │  ◀── Docker Image Push
└─────────────────┘
```

---

## 작업 이력

| 날짜 | Phase | 작업 내용 | 비고 |
|:----|:------|:---------|:----|
| 2026-02-17 | - | 체크리스트 문서 생성 | |
| 2026-02-17 | 0 | Enum, Entity, Repository, Service, DTO, Mapper, Controller 생성 | GitHub #14 |
| 2026-02-17 | 0 | Phase 0 완료 - 커밋 3eaab4f | GitHub #14 closed |
| 2026-02-18 | - | Phase 재구성 (인프라/모니터링 Phase 추가) | Phase 0~9 총 10단계 |
| 2026-02-18 | 1 | Terraform 인프라 구축 (VPC, EC2x2, RDS, ECR) | GitHub #16 |
| 2026-02-18 | 1 | Docker 이미지 빌드 & ECR 푸시, 애플리케이션 배포 | GitHub #16 |
| 2026-02-18 | 1 | Phase 1 완료 - API 테스트 성공 | GitHub #16 closed |

